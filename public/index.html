<!doctype html>
<html lang="en-US">
  
  <head>
    <meta charset="utf-8" />
    <title>ODC Demo</title>
    <meta name="author" content="James Barr" />
    <meta name="description" content="www.odcdemo.com is a spreadsheet explorer for spinal cord injury grants & research. " />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <style>
      th select {
        width: 100%;
        font-size: 0.85rem;
      }
    </style>
  </head>
  
  <body>
    <header>
        <div class="container">
            <div class="brand-left">
                <img src="./images/leftLogo.png" alt="SCI Logo">
                <div>
                <h1>SCI Research Grants Explorer</h1>
                <div>Interactive filters • CSV/XLSX export</div>
            </div>
        </div>
            <div class="partner-right">
              <img src="./images/rightLogo.png" alt="ODC Logo">
            </div>
        </div>
    </header>


    <div class="filter" id = "year">
        <button class = "filter-button" id = "year" onclick="toggleDropdown(this)"> Fiscal Year </button>  
        <div class="dropdown" id="year" style="display: none;">
          <label><input type="checkbox" class="year-checkbox" value="2000"> 2000</label>
          <label><input type="checkbox" class="year-checkbox" value="2001"> 2001</label>
          <label><input type="checkbox" class="year-checkbox" value="2002"> 2002</label>
          <label><input type="checkbox" class="year-checkbox" value="2003"> 2003</label>
          <label><input type="checkbox" class="year-checkbox" value="2004"> 2004</label>
          <label><input type="checkbox" class="year-checkbox" value="2005"> 2005</label>
          <label><input type="checkbox" class="year-checkbox" value="2006"> 2006</label>
          <label><input type="checkbox" class="year-checkbox" value="2007"> 2007</label>
          <label><input type="checkbox" class="year-checkbox" value="2008"> 2008</label>
          <label><input type="checkbox" class="year-checkbox" value="2009"> 2009</label>
          <label><input type="checkbox" class="year-checkbox" value="2010"> 2010</label>
          <label><input type="checkbox" class="year-checkbox" value="2011"> 2011</label>
          <label><input type="checkbox" class="year-checkbox" value="2012"> 2012</label>
          <label><input type="checkbox" class="year-checkbox" value="2013"> 2013</label>
          <label><input type="checkbox" class="year-checkbox" value="2014"> 2014</label>
          <label><input type="checkbox" class="year-checkbox" value="2015"> 2015</label>
          <label><input type="checkbox" class="year-checkbox" value="2016"> 2016</label>
          <label><input type="checkbox" class="year-checkbox" value="2017"> 2017</label>
          <label><input type="checkbox" class="year-checkbox" value="2018"> 2018</label>
          <label><input type="checkbox" class="year-checkbox" value="2019"> 2019</label>
          <label><input type="checkbox" class="year-checkbox" value="2020"> 2020</label>
          <label><input type="checkbox" class="year-checkbox" value="2021"> 2021</label>
          <label><input type="checkbox" class="year-checkbox" value="2022"> 2022</label>
          <label><input type="checkbox" class="year-checkbox" value="2023"> 2023</label>
          <label><input type="checkbox" class="year-checkbox" value="2024"> 2024</label>
          <label><input type="checkbox" class="year-checkbox" value="2025"> 2025</label>
        </div>
        <!-- Add more years as needed -->
    </div>

    <table id="grantsTable" class="display"></table>
    
    <script>


      function toggleDropdown(element){
        // find dropdown using filter button - they're siblings :D 
        const dropdownMenu = element.nextElementSibling;
        // if the element is found, toggle its visibility
        if (dropdownMenu){
          dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
        }
      }

      document.addEventListener("DOMContentLoaded", fetchData);

      // Global array of rows
      let rows = [];
      let filteredRows = [];
      
      function fetchData(){
        fetch('/data')
          .then(response => response.json())
          .then(json => {
            rows = json;
            // render full table, no filter, by default
            renderTable(rows);
            setUpFilterListeners(); 
          })
          .catch(err => {
            console.log("Error fetching/rendering data on page start")
            console.error(err)
          });
      }

      function setUpFilterListeners() {
        const checkboxes = document.querySelectorAll('input[type=checkbox]');
        checkboxes.forEach(element => {
          element.addEventListener("change", updateTable)
        });
      }

      function updateTable(){
        // compile list of filter selections
        const selectedFilters = [];
        document.querySelectorAll('.year-checkbox:checked').forEach(checkbox => {
          selectedFilters.push(checkbox.value); // Push the extracted value into array
        });

        // make filtered dataset using the built-in filter() method & custom predicate
        filteredRows = rows.filter(row => {
          
          // Convert JSON row values into an array of lowercase strings
          let rowValues = Object.values(row);
          const rowStrings = rowValues.map(item => String(item).toLowerCase());
          
          // loop through selected filters
          return selectedFilters.some(selection => {
            // As soon as a filter is ID-ed amongst the row, return TRUE
            return rowStrings.includes(selection);
          });
        });

        renderTable(filteredRows);
      }

      function renderTable(dataRows) {
        const table = document.getElementById("grantsTable");
        let html = `
          <thead>
            <tr>
              <th>Fiscal Year</th><th>Agency</th><th>Agency IC</th><th>Project Number</th>
              <th>Subproject</th><th>Project Title</th><th>Objective (General)</th>
              <th>Objective (Specific)</th><th>Intervention</th><th>Readiness</th>
              <th>PI</th><th>Organization</th><th>State</th><th>Amount</th>
              <th>Mechanism</th><th>URL</th>
            </tr>
          </thead>
          <tbody>
        `;

        dataRows.forEach(row => {
          html += `
            <tr>
              <td>${row.fiscal_year || ""}</td>
              <td>${row.agency || ""}</td>
              <td>${row.agency_ic || ""}</td>
              <td>${row.project_number || ""}</td>
              <td>${row.subproject || ""}</td>
              <td>${row.project_title || ""}</td>
              <td>${row.objective_general || ""}</td>
              <td>${row.objective_specific || ""}</td>
              <td>${row.intervention || ""}</td>
              <td>${row.readiness || ""}</td>
              <td>${row.pi || ""}</td>
              <td>${row.organization || ""}</td>
              <td>${row.state || ""}</td>
              <td>${row.amount || ""}</td>
              <td>${row.mechanism || ""}</td>
              <td><a href="${row.url || "#"}" target="_blank">Link</a></td>
            </tr>
          `;
        });

        html += "</tbody>";
        table.innerHTML = html;
      }

    </script>

<!--     
      // function filterRows(){
        
      // }

      // TRUE/FALSE: row contains selected filter value?
      // function rowChooser(row){
        
      // }

      // tally up all the desired filter values 
      // function getUserSelections(){
        
      //   return selected; // Return the array of selected values
      // }

      // function renderTable(dataRows) {
       
      // } -->
      

      
      

   


    <!-- <script>
      fetch('/data')
        .then(response => response.json())
        .then(rows => {
          const cols = Object.keys(rows[0]).map(k => ({ title: k, data: k }));
          const table = new DataTable('#grantsTable', {
            data: rows,
            columns: cols,
            initComplete: function() {
              this.api().columns().every(function() {
                const column = this;
                const colName = column.header().textContent.toLowerCase();

                // Skip non-categorical columns
                if (['project title', 'state', 'amount'].includes(colName)) return;

                const header = column.header();
                const filterBtn = document.createElement('button');
                filterBtn.textContent = '▼';
                filterBtn.style.marginLeft = '0.25rem';
                filterBtn.style.cursor = 'pointer';
                filterBtn.style.fontSize = '0.8rem';
                header.appendChild(filterBtn);

                const dropdownDiv = document.createElement('div');
                dropdownDiv.style.display = 'none';
                dropdownDiv.style.position = 'absolute';
                dropdownDiv.style.background = '#fff';
                dropdownDiv.style.border = '1px solid #ccc';
                dropdownDiv.style.padding = '0.5rem';
                dropdownDiv.style.maxHeight = '200px';
                dropdownDiv.style.overflowY = 'auto';
                dropdownDiv.style.zIndex = '1000';

                const uniqueValues = [...new Set(column.data().toArray().filter(Boolean))].sort();
                uniqueValues.forEach(val => {
                  const label = document.createElement('label');
                  const cb = document.createElement('input');
                  cb.type = 'checkbox';
                  cb.value = val;
                  cb.style.marginRight = '4px';
                  label.appendChild(cb);
                  label.append(val);
                  dropdownDiv.appendChild(label);
                  dropdownDiv.appendChild(document.createElement('br'));
                });

                header.style.position = 'relative';
                header.appendChild(dropdownDiv);

                filterBtn.addEventListener('click', () => {
                  dropdownDiv.style.display = dropdownDiv.style.display === 'none' ? 'block' : 'none';
                });

                dropdownDiv.addEventListener('change', () => {
                  const checked = Array.from(dropdownDiv.querySelectorAll('input:checked')).map(cb => cb.value);
                  if (checked.length === 0) {
                    column.search('').draw();
                  } else {
                    const regex = checked.map(v => `^${$.fn.dataTable.util.escapeRegex(v)}$`).join('|');
                    column.search(regex, true, false).draw();
                  }
                });

                document.addEventListener('click', e => {
                  if (!dropdownDiv.contains(e.target) && e.target !== filterBtn) {
                    dropdownDiv.style.display = 'none';
                  }
                });
              });
            }
          });
        });
    </script> -->
  </body>
</html>