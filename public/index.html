<!doctype html>
<html lang="en-US">
  
  <head>
    <meta charset="utf-8" />
    <title>ODC Demo</title>
    <meta name="author" content="James Barr" />
    <meta name="description" content="www.odcdemo.com is a spreadsheet explorer for spinal cord injury grants & research. " />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />

    <style>
      th select {
        width: 100%;
        font-size: 0.85rem;
      }
    </style>
  </head>
  
  <body>
    <header>
        <div class="container">
            <div class="brand-left">
                <img src="./images/leftLogo.png" alt="SCI Logo">
                <div>
                <h1>SCI Research Grants Explorer</h1>
                <div>Interactive filters â€¢ CSV/XLSX export</div>
            </div>
        </div>
            <div class="partner-right">
              <img src="./images/rightLogo.png" alt="ODC Logo">
            </div>
        </div>
    </header>

    <table id="grantsTable" class="display">
      <thead id="tableHeader"></thead>
      <tbody id="tableBody"></tbody>
    </table>
    
    <script>


      function toggleDropdown(element){
        // find dropdown using filter button - they're siblings :D 
        const dropdownMenu = element.nextElementSibling;
        // if the element is found, toggle its visibility
        if (dropdownMenu){
          dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
        }
      }

      document.addEventListener("DOMContentLoaded", fetchData);

      // Global array of rows
      let rows = [];
      let filteredRows = [];
      // MAP of all filter categories & desired properties 
      const filterCategories = {
        fiscal_year:  { label: "Fiscal Year", class: "year-checkbox", type: "numeric" },
        agency:       { label: "Agency", class: "agency-checkbox", type: "categorical" },
        agency_ic:    { label: "Agency IC", class: "agencyic-checkbox", type: "categorical" },
        objective_general:  { label: "Objective (General)", class: "objective-general-checkbox", type: "categorical" },
        objective_specific: { label: "Objective (Specific)", class: "objective-specific-checkbox", type: "categorical" },
        intervention: { label: "Intervention", class: "intervention-checkbox", type: "categorical" },
        readiness:    { label: "Readiness", class: "readiness-checkbox", type: "categorical" },
        state:        { label: "State", class: "state-checkbox", type: "categorical" }
      };
      
      const dataColumns = [
        "fiscal_year", "agency", "agency_ic", "project_number", "subproject",
        "project_title", "objective_general", "objective_specific",
        "intervention", "readiness", "pi", "organization", "state",
        "amount", "mechanism", "url"
      ];

     
      
      function fetchData(){
        fetch('/data')
          .then(response => response.json())
          .then(json => {
            rows = json;
            // render full table, no filter, by default
            setUpFilters(rows);
            renderTable(rows);
            setUpFilterListeners(); 
          })
          .catch(err => {
            console.log("Error fetching/rendering data on page start")
            console.error(err)
          });
      }

      function setUpFilterListeners() {
        const checkboxes = document.querySelectorAll('input[type=checkbox]');
        checkboxes.forEach(element => {
          element.addEventListener("change", updateTable)
        });
      }


      function setUpFilters(rows){
        let headerHTML = "<tr>";

        dataColumns.forEach( column => {
          // Handle Filter Columns
          if (filterCategories[column]){
            // locate HTML/CSS naming conventions for filter
            const attributes = filterCategories[column];

            // screen full dataset, store unique values
            const set = new Set();
            rows.forEach(row => {
              const rawVal = row[column];
              const s = String(rawVal ?? "").trim();
              if (s) set.add(s);
            });

            // Get a nice clean array of column values
            const values = Array.from(set).sort();

            // turn each value into a checkbox w/ appropriate values & class
            let filterHTML = `
              <div class="filter" id="${column}">
                <button class="filter-button" onclick="toggleDropdown(this)">${attributes.label}</button>
                <div class="dropdown" style="display:none;">
                  
                  ${values.map(v => `
                    <label>
                      <input type="checkbox" class="${attributes.class}" value="${v}">
                      ${v}
                    </label>
                  `).join("")}
                </div>
              </div>
            `;
            // add FILTER MENU to header, wrapped in a table header cell
            headerHTML += `<th>${filterHTML}</th>`;
          } else {
            // handle default column labels
            const label = column.replace(/_/g, " "); // Get simple name
            headerHTML += `<th>${label.charAt(0).toUpperCase() + label.slice(1)}</th>`;
          }
        });
        // Cap the end of the header HTML, and it's ready for display
        headerHTML += "</tr>";
        
        // Append to existing table + header scaffolding
        document.getElementById("tableHeader").innerHTML = headerHTML;
      }  
      

      // Table is updated whenever a new filter is selected 
      function updateTable(){

        const selectedFilters = Array.from(document.querySelectorAll('input[type=checkbox]:checked'))
          .map(cb => String(cb.value).toLowerCase().trim());
        
        if (selectedFilters.length === 0) {
          // No filters selected: show all rows
          renderTable(rows);
          return;
        }
        
        // Build filtered dataset using case-insensitive match across row values
        filteredRows = rows.filter(row => {
          const rowStrings = Object.values(row).map(item => String(item).toLowerCase());
          return selectedFilters.some(sel => rowStrings.includes(sel));
        });
        
        renderTable(filteredRows);
      }

      function renderTable(dataRows) {
        const tbody = document.getElementById("tableBody");
        let rowsHTML = "";
      
        dataRows.forEach(row => {
          rowsHTML += `
            <tr>
              <td>${row.fiscal_year || ""}</td>
              <td>${row.agency || ""}</td>
              <td>${row.agency_ic || ""}</td>
              <td>${row.project_number || ""}</td>
              <td>${row.subproject || ""}</td>
              <td>${row.project_title || ""}</td>
              <td>${row.objective_general || ""}</td>
              <td>${row.objective_specific || ""}</td>
              <td>${row.intervention || ""}</td>
              <td>${row.readiness || ""}</td>
              <td>${row.pi || ""}</td>
              <td>${row.organization || ""}</td>
              <td>${row.state || ""}</td>
              <td>${row.amount || ""}</td>
              <td>${row.mechanism || ""}</td>
              <td><a href="${row.url || "#"}" target="_blank">Link</a></td>
            </tr>
          `;
        });
      
        tbody.innerHTML = rowsHTML;
      }

    </script>
  </body>
</html>